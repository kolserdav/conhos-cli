# Файл конфигурации проекта

Файл конфигурации проекта это обязательный файл, который служит для настройки сервисов проекта, он должен быть разположен в корне проекта и его содержание должно соответствовать строгим правилам, которые описаны далее.

> Если ваш проект находится в Git репозитории, то можно настраивать файл конфигурации прямо из браузера.

> Для автоматического создания базового файла конфигурации вы можете обратиться к [Инициализация проекта](./GettingStarted.md#init)

## Пример файла конфигурации [![якорь](https://conhos.ru/images/icons/link.svg)](#config-file-ex)

```yml
name: name-of-project # Название проекта
services:
  node1:
    image: node # Среда исполнения Node.js
    size: mili # Размер сервиса (влияет на цену)
    active: true # Сервис запущен
    version: latest # Версия контейнера
    pwd: examples/postgres # Путь до рабочей папки (файлы и папки из этого пути будут загружены в облако)
    volumes: # [ОПЦИОНАЛЬНО] Загрузка дополнительных файлов в контейнер
      - https://raw.githubusercontent.com/kolserdav/conhos-cli/master/examples/php/install-extensions.sh:install-extensions.sh
      # Подключение локальномо тома
      - local:/path
    entrypoint: ['install-extensions.sh'] # [ОПЦИОНАЛЬНО] Скрипты запускаемые при создании контейнера
    exclude: # [ОПЦИОНАЛЬНО] Файлы и папки исключения (путь относительно корня "pwd")
      - tmp
      - node_modules
    command: npm i && npm run start # Команда при старте контейнера
    ports: # [ОПЦИОНАЛЬНО] Список внешних портов
      - port: 3000
        type: proxy
    deploy: # [ОПЦИОНАЛЬНО] Параметры развертывания
      replicas: 2 # [ОПЦИОНАЛЬНО] Количество реплик (каждая реплика оплачивается как отдельная единица)
      update_config: # [ОПЦИОНАЛЬНО] Параметры обновления
        parallelism: 1 # [ОПЦИОНАЛЬНО] Количество одновременно обновляемых реплик
        delay: 3s # [ОПЦИОНАЛЬНО] Задержка после обновления реплики перед обновлением следующей
    environment: # [ОПЦИОНАЛЬНО] Переменные окружения
      - PORT=3000
# Локальные тома
volumes:
  localVolume:
    name: local
```

## Поля файла конфигурации верхнего уровня [![якорь](https://conhos.ru/images/icons/link.svg)](#top-level-props)

### Название проекта [![якорь](https://conhos.ru/images/icons/link.svg)](#project-name)

Идентификатор проекта в облаке

```yml
name: my-awesome-project
```

**Вам строго необходимо следить за уникальностью этого поля между разными проектами, иначе один ваш проект перезапишет другой проект в облаке.**

### Локальные тома [![якорь](https://conhos.ru/images/icons/link.svg)](#volumes)

Локальные тома служат для сохранения файлов между перезапусками сервиса, а также для доступа к файлам сервиса из другого сервиса.

```yml
volumes:
  key:
    name: 'name'
```

После создания локального тома в `volumes` необходимо также добавить данный том в `service.volumes` например:

```yml
services:
  node:
    volumes:
      # Указываем имя тома и путь
      - name:/path
    ...
```

### Сервисы [![якорь](https://conhos.ru/images/icons/link.svg)](#services)

Перечень сервисов которые необходимы для работы приложения проекта

```yml
services:
  # Уникальное имя сервиса
  node0:
    # ... Поля конфигурации сервиса
```

Подробнее о сервисах смотрите в [Поля конфигурации сервиса](./ConfigFile.md#service-level-props)

## Поля конфигурации сервиса [![якорь](https://conhos.ru/images/icons/link.svg)](#service-level-props)

Поле верхнего уровня **services** должно иметь корневое поле с произвольным уникальным названием и вложенный перечень обязательных и опциональных полей.

### Тип сервиса [![якорь](https://conhos.ru/images/icons/link.svg)](#service-image)

От этого зависит образ операционной системы и перечень установленных зависимостей сервиса

```yml
image: node
```

Поддерживаемые типы сервисов: _'node' | 'rust' | 'golang' | 'php' | 'ruby' | 'python' | 'redis' | 'postgres' | 'mysql' | 'mariadb' | 'mongo' | 'rabbitmq' | 'mongo_express' | 'adminer' | 'phpmyadmin' | 'custom'_

#### Кастомный контейнер [![якорь](https://conhos.ru/images/icons/link.svg)](#custom-container)

Чтобы запустить сервис на основе любого из образов на Docker Hub нужно указать `custom` а в `version` прописать _'автор/название:версия'_ образа.

```yml
image: custom
version: dart # Будет устаовлено из официального репозитория Dart версия latest (по умолчанию)
```

#### Собрать контейнер из Dockerfile [![якорь](https://conhos.ru/images/icons/link.svg)](#custom-container-build)

Собрать специальный образ для сервиса из `Dockerfile`. Срабатывает только при команде `conhos deploy`.

> После изменения Dockerfile в репозитории если нужно чтобы контейнер пересобрался, нужно запустить команду `deploy` вручную.

```yml
image: custom # Обязательно такое значение для использования build
build:
  dockerfile: Dockerfile # Относительный путь до Dockerfile в контексте "project-path/pwd"
```

### Размер сервиса [![якорь](https://conhos.ru/images/icons/link.svg)](#service-size)

От этого зависит выделение ресуров облачного сервера для работы конкретного сервиса

> Данный параметр влияет на цену. Таблицу цен смотрите на [главной странице](/#price)

```yml
size: mili
```

Поддерживаемые типы размеров: _'pico' | 'nano' | 'micro' | 'mili' | 'santi' | 'deci' | 'deca' | 'hecto' | 'kilo'_

### Активный сервис [![якорь](https://conhos.ru/images/icons/link.svg)](#service-active)

Чтобы сервис был добавлен или обновлен необходимо указать **true**. Если указано **false** то сервис будет удален из облака

```yml
active: true
```

### Версия сервиса [![якорь](https://conhos.ru/images/icons/link.svg)](#service-version)

Версия сервиса взятая с оффициального DockerHub репозитория. Например для Node.js будет валидной один из поддерживаемых в нстоящее время тегов https://hub.docker.com/_/node

```yml
version: latest
```

### Без перезагрузки [![якорь](https://conhos.ru/images/icons/link.svg)](#service-no-restart)

Чтобы сервис не перезапускался при перезапуске проекта - **true**

> Используется там где перезапуск контейнера не требуется после обновления файлов приложения. Например для сервисов работающих на `php-fpm`.

```yml
no_restart: true
```

### Стартовая команда [![якорь](https://conhos.ru/images/icons/link.svg)](#service-command)

Команда выполняемая при старте сервиса. Должна содержать команды установки и сборки перед запуском программы если это необходимо.

```yml
command: npm i && npm run start
```

### Порты [![якорь](https://conhos.ru/images/icons/link.svg)](#service-ports)

Порты, которые должны быть проброшены для публичных сервисов наружу, для каждого порта будет использоваться отдельный адрес в сети на 80 и 443 порту.

> `ports` указывает что порт должен быть открытым для интернета по доменному имени, а иначе доступ к сервису можно получить только через [Внутренние ссылки](./ConfigFile.md#internal-links) для других сервисов проекта.

[**Подробнее о портах**](./Ports.md)

### Развертывание [![якорь](https://conhos.ru/images/icons/link.svg)](#service-deploy)

Настройка горизонтального масштабирования сервиса

```yml
deploy:
  replicas: 2
  update_config:
    parallelism: 1
    delay: 3s
```

### Реплики [![якорь](https://conhos.ru/images/icons/link.svg)](#service-deploy-replicas)

Количество экземпляров (контейнеров) сервиса, которые будут отвечать через балансировщик нагрузки.

> Данный параметр допустим только для исполняемых сервисов

```yml
deploy:
  replicas: 2
```

#### Настройка обновления [![якорь](https://conhos.ru/images/icons/link.svg)](#service-deploy-update-config)

Настройки политики обновления сервиса.

##### Параллелизм [![якорь](https://conhos.ru/images/icons/link.svg)](#service-deploy-update-config-parallelism)

Устанавливает количество одновременно перезапускаемых реплик сервиса, во время обновления и перезапуска.

```yml
deploy:
  update_config:
    parallelism: 1
```

##### Задержка [![якорь](https://conhos.ru/images/icons/link.svg)](#service-deploy-update-config-delay)

Время задержки после перезапуска реплики до начала запуска следующей.

```yml
deploy:
  update_config:
    delay: 3s
```

### Переменные среды [![якорь](https://conhos.ru/images/icons/link.svg)](#service-environment)

Массив переменных среды, которые будут доступны процессам внутри сервиса

> Поддерживается использование переменных среды вашего устройства в любом месте файла, например: `${PORT}`

```yml
environment:
  - PORT=3000
```

### Порядок запуска [![якорь](https://conhos.ru/images/icons/link.svg)](#depends-on)

Массив имен сервисов которые должны быть запущены перед данным сервисом.

```yml
depends_on:
  - postgres0
```

### Загрузка файлов из Git [![якорь](https://conhos.ru/images/icons/link.svg)](#git)

Данный параметр подгружает файлы из Git репозитория и следит за изменениями в указанной ветке, в случае необходимости обновляет сервис.

> **Если указан приватный репозиторий, то необходимо настроить в личном кабинете права доспупа к приватным репозиториям для приложения Conhos**

> Обратите внимание на параметр `pwd` при наличии `git` он будет скачивать из репозитория только ту папку, которая указана в `pwd` и сделает её корнем в контейнере

```yml
git:
  url: https://github.com/user/repository.git # Адрес репозитория
  branch: master # Название рабочей ветки
  # Опционально
  untracked: merge # Политика слияния
```

#### Поддерживаетмые политики слияния [![якорь](https://conhos.ru/images/icons/link.svg)](#git-untracked)

В случае изменений на диске, `git pull` работает по следующим правилам:

- `merge`: По умолчанию. Сервис пробует выполнить автоматическое слияние с файлами из рабочей ветки и обновить рабочую ветку с учетом локальных изменений. Если слияние не может быть выполнено автоматически, то изменения на сервере выгружаются в новую ветку, а сервис продолжает работу с файлами из рабочей ветки.
- `push`: Изменения на сервере сразу выгружаются в новую ветку, а сервис продолжает работу с файлами из рабочей ветки.
- `checkout`: Локальные изменения на сервере отменяются и сервис продолжает работу с файлами из рабочей ветки.

### Рабочая папка [![якорь](https://conhos.ru/images/icons/link.svg)](#pwd)

Данная директория будет загружена в облако и станет рабочей директорией сервиса

> Если для сервиса указан параметр `git`, то данное правило (`pwd`) будет указывать на директорию внутри Git проекта

```yml
pwd: ./ # Только относительный путь
```

### Исключения [![якорь](https://conhos.ru/images/icons/link.svg)](#exclude)

Перечень дочерних файлов или папок, которые не должны загружаться в облако

```yml
# Опционально
exclude:
  - node_modules
  - dist
  - some/nested
```

### Внедрение конфигурации [![якорь](https://conhos.ru/images/icons/link.svg)](#volumes)

Для перезаписи конфигурационных файлов внутри контейнера.

> `volumes` служит только для передачи небольших файлов внутрь контейнеров для настройки процессов контейнера.

```yml
# Опционально
volumes:
  # - [абсолютный или относительный путь до файла]:[абсолютный путь до файла внутри контейнера]
  - examples/mysql/config/my.cf:/etc/mysql/conf.d/custom.cnf
```

### Запуск скрипта при старте контейнера [![якорь](https://conhos.ru/images/icons/link.svg)](#entrypoint)

> За исключением сервиса `postgres`, в котором для запуска скриптов при создании не нужно передавать `entrypoint` вместо этого передаем через `volumes` внутрь контейнера файл `/docker-entrypoint-initdb.d/init.sql` с примерным содержанием:

```sh
#!/bin/sh
config_path=/var/lib/postgresql/data/postgresql.conf
echo "Add include dir to config $config_path"
echo "include_dir='/etc/postgresql'" >> $config_path

```

```yml
# Опционально
entrypoint: ['install-extensions.sh']
```

## Использование своего домена [![якорь](https://conhos.ru/images/icons/link.svg)](#custom-domain)

Для установки своего домена просто добавьте такое поле в конфигурацию сервиса:

```yml
domains:
  '3000': example.ru
```

> Чтобы собственный домен заработал, обязательно убедитесь, что в хостинговой зоне этого домена добавлена `A` запись с IP узла на котором расположен ваш проект.
> Для получения IP узла проекта введите команду:

```sh
conhos ip
```

Чтобы изменения вступили в силу, после смены домена введите команду:

```sh
conhos deploy
```
